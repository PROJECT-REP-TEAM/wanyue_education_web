<include file="public@header" />
<style>
	.uid_list{
		margin: 0;
		padding: 0;
	}
	.uid_list ul{
		margin: 0;
		padding: 0;
	}
	.uid_list li{
		display: inline-block;
		float: left;
		position: relative;
		list-style: none;
	}
	.uid_list span{
		display: inline-block;
		margin-right: 10px;
		padding: 0 18px;
		min-width: 80px;
		height: 40px;
		line-height: 40px;
		text-align: center;
		color: #323232;
		font-size: 14px;
		background: #ffffff;
		border: 1px solid #f0f0f0;
		border-radius: 5px;
		-moz-box-sizing: border-box;
		-webkit-box-sizing: border-box;
		-o-box-sizing: border-box;
		-ms-box-sizing: border-box;
		box-sizing: border-box;
	}
	.uid_list span.on {
		margin: 0;
		color: #38DAA6;
		border: 1px dashed #38daa6;
		cursor: pointer;
	}
	.uid_list li i{
		position: absolute;
		top: 3px;
		right: 13px;
		width: 10px;
		height: 10px;
		background: url('/static/teacher/images/white/practice_del.png') no-repeat center center;
		background-size: 10px 10px;
		cursor: pointer;
	}
</style>
</head>
<body>
	<div class="wrap">
		<ul class="nav nav-tabs">
			<li ><a href="{:url('course/index',['sort'=>$sort])}">列表</a></li>
			<li class="active"><a >{:lang('EDIT')}</a></li>
		</ul>
		<form method="post" class="form-horizontal js-ajax-form margin-top-20" action="{:url('course/editPost')}">
			<div class="form-group">
				<label class="col-sm-2 control-label"><span class="form-required">*</span>主讲老师</label>
				<div class="col-md-6 col-sm-10">
					<div class="uid_list">
						<ul>
							<li data-uid="{$data.userinfo.id}"><input type="hidden" name="uid" value="{$data.userinfo.id}"><span>{$data.userinfo.user_nickname}</span><i></i></li>
						</ul>
						<span class="on getuid" data-type="0">选择教师</span>
					</div>
				</div>
			</div>

			<if condition="$sort neq 0">
				<div class="form-group">
					<label class="col-sm-2 control-label"><span class="form-required"></span>辅导老师</label>
					<div class="col-md-6 col-sm-10">
						<div class="uid_list">
							<ul>
								<if condition="$data['tutoruid'] gt 0">
									<li data-uid="{$data.tutorinfo.id}"><input type="hidden" name="uid" value="{$data.tutorinfo.id}"><span>{$data.tutorinfo.user_nickname}</span><i></i></li>
								</if>
							</ul>
							<span class="on getuid" data-type="1">选择教师</span>
						</div>
					</div>
				</div>
			</if>
            
            <div class="form-group">
				<label for="input-name" class="col-sm-2 control-label"><span class="form-required">*</span>学级分类</label>
				<div class="col-md-6 col-sm-10">
					<select class="form-control" name="gradeid">
                        <volist name="grade" id="v">
                        <option value="{$v['id']}" <eq name="data['gradeid']" value="$v['id']">selected</eq> >{$v['name']}</option>
                        </volist>
                    </select>
				</div>
			</div>

            <div class="form-group">
				<label for="input-name" class="col-sm-2 control-label"><span class="form-required">*</span>名称</label>
				<div class="col-md-6 col-sm-10">
					<input type="text" class="form-control" id="input-name" name="name" value="{$data.name}">
				</div>
			</div>
            
            <div class="form-group">
				<label for="input-user_login" class="col-sm-2 control-label"><span class="form-required">*</span>封面</label>
				<div class="col-md-6 col-sm-10">
					<input type="hidden" name="thumb" id="thumbnail" value="{$data.thumb}">
                    <a href="javascript:uploadOneImage('图片上传','#thumbnail');">
                        <if condition="empty($data.thumb)">
                        <img src="__TMPL__/public/assets/images/default-thumbnail.png"
                                 id="thumbnail-preview"
                                 style="cursor: pointer;max-width:100px;max-height:100px;"/>
                        <else/>
                        <img src="{:cmf_get_image_preview_url($data.thumb)}"
                             id="thumbnail-preview"
                             style="cursor: pointer;max-width:100px;max-height:100px;"/>
                        </if>
                    </a>
                    <input type="button" class="btn btn-sm btn-cancel-thumbnail" value="取消图片"> 比例：4:3  建议尺寸：200 X 150
				</div>
			</div>
            
            <div class="form-group">
				<label for="input-des" class="col-sm-2 control-label"><span class="form-required"></span>简介</label>
				<div class="col-md-6 col-sm-10">
					<textarea class="form-control" name="des" style="height: 50px;" maxlength="30">{$data.des}</textarea>最多30个字
				</div>
			</div>
            
            <if condition="$sort neq 1 && $sort neq 3">
            <div class="form-group">
				<label for="input-name" class="col-sm-2 control-label"><span class="form-required">*</span>内容形式</label>
				<div class="col-md-6 col-sm-10">
					<select class="form-control" name="type" id="type">
                        <volist name="types" id="v">
                        <option value="{$key}" <eq name="data['type']" value="$key">selected</eq>>{$v}</option>
                        </volist>
                    </select>
				</div>
			</div>
            
            <div class="form-group type_bd type_2" style="display:none;">
				<label for="input-url" class="col-sm-2 control-label"><span class="form-required">*</span>上传视频</label>
				<div class="col-md-6 col-sm-10">
					<input class="form-control" id="js-file-input3" type="text" name="type_video" style="width: 300px;display: inline-block;" title="文件名称" value="{$data.url}">
                    <a href="javascript:uploadOne('文件上传','#js-file-input3','video');">上传文件</a>MP4格式
				</div>
			</div>
            
            <div class="form-group type_bd type_3" style="display:none;">
				<label for="input-url" class="col-sm-2 control-label"><span class="form-required">*</span>上传语音</label>
				<div class="col-md-6 col-sm-10">
					<input class="form-control" id="js-file-input4" type="text" name="type_audio" style="width: 300px;display: inline-block;" title="文件名称" value="{$data.url}">
                    <a href="javascript:uploadOne('文件上传','#js-file-input4','audio');">上传文件</a>MP3格式 WAV格式
				</div>
			</div>
            
            </if>
            
            <div class="form-group">
				<label for="input-name" class="col-sm-2 control-label"><span class="form-required">*</span>获取方式</label>
				<div class="col-md-6 col-sm-10">
                    <input type="hidden" name="paytype" id="paytype" value="{$data['paytype']}">
					<select class="form-control" disabled>
                        <volist name="paytypes" id="v">
                        <option value="{$key}" <eq name="data['paytype']" value="$key">selected</eq>>{$v}</option>
                        </volist>
                    </select>
				</div>
			</div>
            
            <div class="form-group" id="paytype_val" style="display:none;">
				<label for="input-payval" class="col-sm-2 control-label"><span class="form-required">*</span>价格/密码</label>
				<div class="col-md-6 col-sm-10">
					<input type="text" class="form-control" id="input-payval" name="payval" value="{$data.payval}"> 添加价格时最多保留2位小数
				</div>
			</div>
            <if condition="$sort eq 1">
            <div class="form-group paytype_bd paytype_1" style="display:none;">
				<label for="input-name" class="col-sm-2 control-label"><span class="form-required"></span>是否含有教材</label>
				<div class="col-md-6 col-sm-10">
					<select class="form-control" name="ismaterial" id="ismaterial">
                        <option value="0">否</option>
                        <option value="1" <eq name="data['ismaterial']" value="1">selected</eq>>是</option>
                    </select>
				</div>
			</div>
            
            <div class="form-group">
				<label for="input-name" class="col-sm-2 control-label"><span class="form-required"></span>课程模式</label>
				<div class="col-md-6 col-sm-10">
					<select class="form-control" name="mode" id="mode">
                        <volist name="modes" id="v">
                        <option value="{$key}" <eq name="data['mode']" value="$key">selected</eq>>{$v}</option>
                        </volist>
                    </select>  
                    自由模式可随时学习任意课时，解锁模式需按照课时顺序学习
				</div>
			</div>
            </if>
            
            <if condition="$sort eq 0">
            <div id="paytype_bd" style="display:none;">
                <div class="form-group">
                    <label for="input-name" class="col-sm-2 control-label"><span class="form-required"></span>试学</label>
                    <div class="col-md-6 col-sm-10">
                        <select class="form-control" name="trialtype" id="trialtype">
                            <volist name="trialtypes" id="v">
                            <option value="{$key}" <eq name="data['trialtype']" value="$key">selected</eq>>{$v}</option>
                            </volist>
                        </select>
                    </div>
                </div>
                
                <div class="form-group trialtype_bd" id="trialval_2" style="display:none;">
                    <label for="input-trialval_2" class="col-sm-2 control-label"><span class="form-required">*</span>时间进度</label>
                    <div class="col-md-6 col-sm-10">
                        <input type="text" class="form-control" id="input-trialval_2" name="trialval_2" value="{$data.trialval}">秒 开始的多少秒可看
                    </div>
                </div>
                <div class="form-group trialtype_bd" id="trialval_1" style="display:none;">
                    <label for="input-trialval_1" class="col-sm-2 control-label"><span class="form-required">*</span>进度</label>
                    <div class="col-md-6 col-sm-10">
                        <input type="text" class="form-control" id="input-trialval_1" name="trialval_1" value="{$data.trialval}">%  范围：1-99
                    </div>
                </div>
            </div>
            </if>
            
            <div class="form-group">
				<label for="input-name" class="col-sm-2 control-label"><span class="form-required">*</span>状态</label>
				<div class="col-md-6 col-sm-10">
					<select class="form-control" name="status" id="status">
                        <option value="1" <eq name="data['status']" value="1">selected</eq>>立即上架</option>
                        <option value="-1" <eq name="data['status']" value="-1">selected</eq>>暂不上架</option>
                        <option value="2" <eq name="data['status']" value="2">selected</eq>>定时上架</option>
                    </select>
				</div>
			</div>
            
            <div class="form-group status_bd" <if condition="$data['status'] neq 2">style="display:none;"</if>>
				<label for="input-shelvestime" class="col-sm-2 control-label"><span class="form-required">*</span>上架时间</label>
				<div class="col-md-6 col-sm-10">
					<input type="text" class="form-control js-bootstrap-datetime" id="input-shelvestime" name="shelvestime"  aria-invalid="false" autocomplete="off" value="{:date('Y-m-d H:i:s',$data.shelvestime)}"> 格式：2020-01-01 00:00:00
				</div>
			</div>
            
            <if condition="$sort eq 2 || $sort eq 3">
            <div class="form-group">
				<label for="input-starttime" class="col-sm-2 control-label"><span class="form-required">*</span>上课时间</label>
				<div class="col-md-6 col-sm-10">
					<input type="text" class="form-control js-bootstrap-datetime" id="input-starttime" name="starttime"  aria-invalid="false" autocomplete="off" value="{:date('Y-m-d H:i:s',$data.starttime)}"> 格式：2020-01-01 00:00:00
				</div>
			</div>
            <div class="form-group">
				<label for="input-endtime" class="col-sm-2 control-label"><span class="form-required">*</span>下课时间</label>
				<div class="col-md-6 col-sm-10">
					<input type="text" class="form-control js-bootstrap-datetime" id="input-endtime" name="endtime"  aria-invalid="false" autocomplete="off" value="{:date('Y-m-d H:i:s',$data.endtime)}"> 格式：2020-01-01 00:00:00
				</div>
			</div>
            <div class="form-group">
				<label for="input-intr" class="col-sm-2 control-label"><span class="form-required"></span>听课指南</label>
				<div class="col-md-6 col-sm-10">
					<textarea class="form-control" name="intr" style="height: 50px;" maxlength="200">{$data.intr}</textarea> 留空为显示默认指南 最多200字
				</div>
			</div>
            </if>
            
            
            
            <div class="form-group">
				<label for="input-info" class="col-sm-2 control-label"><span class="form-required">*</span>介绍</label>
				<div class="col-md-6 col-sm-10">
					<script type="text/plain" id="info" name="info">{$data.info}</script> 学员购买前可看
				</div>
			</div>
            
            <if condition="$sort eq 0">
            <div class="form-group">
				<label for="input-name" class="col-sm-2 control-label"><span class="form-required">*</span>详情</label>
				<div class="col-md-6 col-sm-10">
					<script type="text/plain" id="content" name="content">{$data.content}</script>
				</div>
			</div>
            </if>
            
			<div class="form-group">
				<div class="col-sm-offset-2 col-sm-10">
                    <input type="hidden" name="sort" value="{$sort}" />
                    <input type="hidden" name="id" value="{$data.id}" />
					<button type="submit" class="btn btn-primary js-ajax-submit">{:lang('EDIT')}</button>
					<a class="btn btn-default" href="javascript:history.back(-1);">{:lang('BACK')}</a>
				</div>
			</div>
            
		</form>
	</div>
	<div class="userlist form-horizontal margin-top-20" style="display: none">
		<div class="form-group" style="margin: 0">
			<label class="col-sm-2 control-label"><span class="form-required">*</span>教师</label>
			<div class="col-md-6 col-sm-10">
				<select class="form-control" id="s_uid"></select>
			</div>
		</div>
	</div>
	<script src="__STATIC__/js/admin.js"></script>
    <script type="text/javascript">
        //编辑器路径定义
        var editorURL = GV.WEB_ROOT;
    </script>
    <script type="text/javascript" src="__STATIC__/js/ueditor/ueditor.config.js"></script>
    <script type="text/javascript" src="__STATIC__/js/ueditor/ueditor.all.min.js"></script>
    <script type="text/javascript">
		Wind.use('layer');
        $(function () {
            $('.btn-cancel-thumbnail').click(function () {
                $('#thumbnail-preview').attr('src', '__TMPL__/public/assets/images/default-thumbnail.png');
                $('#thumbnail').val('');
            });
            editorcontent = new baidu.editor.ui.Editor();
            editorcontent.render('content');
            try {
                editorcontent.sync();
            } catch (err) {
            }
            
            editorcontent2 = new baidu.editor.ui.Editor();
            editorcontent2.render('info');
            try {
                editorcontent2.sync();
            } catch (err) {
            }
            
            var sort='{$sort}';
            /* 内容方式处理 */
            function type_change(){
                var type=$('#type').val();
                $('.type_bd').hide();
                $('.type_'+type).show();
                
                $('.trialtype_bd').hide();
                if(type!=1){
                    type=2;
                }

                $('#trialval_'+type).show();
            }
            $("#type").on('change',function(){
                type_change();
            })
            type_change();
            
            /* 获取方式处理 */
            function paytype_change(){
                var paytype=$('#paytype').val();
                $('.paytype_bd').hide();
                $('.paytype_'+paytype).show();
                if(paytype==0){
                    $('#paytype_val').hide();
                    $('#input-payval').val('');
                    $('#paytype_bd').hide();
                }else{
                    $('#paytype_val').show();
                    $('#paytype_bd').show();
                }
                if(paytype==2 && sort==0){
                    $('#paytype_bd').hide();
                }
            }
            $("#paytype").on('change',function(){
                paytype_change();
            })
            paytype_change();
            
            /* 试学方式处理 */
            function trialtype_change(){
                var trialtype=$('#trialtype').val();
                var type=$('#type').val();
                if(trialtype==0){
                    $('.trialtype_bd').hide();
                }else{
                    $('.trialtype_bd').hide();
                    if(type!=1){
                        type=2;
                    }
                    $('#trialval_'+type).show();
                }
            }
            $("#trialtype").on('change',function(){
                trialtype_change();
            })
            trialtype_change();
            
            /* 上架处理 */
            function status_change(){
                var status=$('#status').val();
                if(status==2){
                    $('.status_bd').show();
                }else{
                    $('.status_bd').hide();
                }
            }
            $("#status").on('change',function(){
                status_change();
            })
            status_change();


			function getUserList(uid=0){
				$.ajax({
					url:'/admin/Course/getUserList',
					type:'POST',
					data:{uid:uid},
					dataType:'json',
					error:function(e){
						layer.msg('网络错误');
					},
					success:function(data){
						if(data.code==0){
							layer.msg(data.msg);
							return !1;
						}

						var html='';
						var list=data.data;
						var nums=list.length;
						for(var i=0;i<nums;i++){
							var v=list[i];
							html+='<option value="'+v.id+'">'+v.user_nickname+'</option>';
						}

						$('.userlist').find('#s_uid').html(html);
					}
				})
			}

			$('.getuid').on('click',function (){
				let _this=$(this);
				let _this_p=_this.parent('.uid_list');
				let type=_this.data('type');
				if(_this_p.find('ul').find('li').length>0){
					return !1
				}
				getUserList();
				layer.open({
					type: 1,
					title: '选择教师',
					btn: ['确定', '取消'],
					shadeClose: true,
					shade: 0.8,
					area: ['60%', '200px'],
					content: $('.userlist'),
					yes:function (index){

						let selected_g=$('#s_uid option:selected');
						let s_g_id=selected_g.val();
						let s_g_n=selected_g.text();

						let isexist=_this_p.find('ul li[data-uid="'+s_g_id+'"]');
						if(isexist.length !=0){
							return !1;
						}
						layer.close(index);
						let name='uid';
						if(type==1){
							name='tutoruid';
						}
						let html='<li data-uid="'+s_g_id+'"><input type="hidden" name="'+name+'" value="'+s_g_id+'"><span>'+s_g_n+'</span><i></i></li>';
						_this_p.find('ul').append(html);
					}
				});
			})

			$('.uid_list').on('click','i',function (){
				$(this).parents('li').remove();
			})

        });
    </script>
</body>
</html>